--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

--// GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PetFinderESP"
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 320, 0, 340)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -170)
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Title
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1,0,0,30)
Title.BackgroundColor3 = Color3.fromRGB(20,20,20)
Title.Text = "Pet Finder + ESP"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 16
Title.Parent = MainFrame

-- Close / Minimize
local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0,30,0,30)
CloseBtn.Position = UDim2.new(1,-30,0,0)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(170,50,50)
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.Parent = MainFrame

local MinBtn = Instance.new("TextButton")
MinBtn.Size = UDim2.new(0,30,0,30)
MinBtn.Position = UDim2.new(1,-60,0,0)
MinBtn.Text = "-"
MinBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
MinBtn.TextColor3 = Color3.new(1,1,1)
MinBtn.Parent = MainFrame

-- Search Box
local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(1,-20,0,30)
SearchBox.Position = UDim2.new(0,10,0,40)
SearchBox.PlaceholderText = "Ketik nama pet..."
SearchBox.BackgroundColor3 = Color3.fromRGB(45,45,45)
SearchBox.TextColor3 = Color3.new(1,1,1)
SearchBox.Parent = MainFrame

-- Autocomplete Frame
local AutoFrame = Instance.new("Frame")
AutoFrame.Size = UDim2.new(1,-20,0,100)
AutoFrame.Position = UDim2.new(0,10,0,75)
AutoFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
AutoFrame.Visible = false
AutoFrame.Parent = MainFrame

local AutoList = Instance.new("UIListLayout")
AutoList.Parent = AutoFrame
AutoList.Padding = UDim.new(0,2)

-- Clear Button
local ClearBtn = Instance.new("TextButton")
ClearBtn.Size = UDim2.new(1,-20,0,30)
ClearBtn.Position = UDim2.new(0,10,0,180)
ClearBtn.Text = "Clear"
ClearBtn.BackgroundColor3 = Color3.fromRGB(150,50,50)
ClearBtn.TextColor3 = Color3.new(1,1,1)
ClearBtn.Parent = MainFrame

-- Result Frame
local ResultFrame = Instance.new("ScrollingFrame")
ResultFrame.Size = UDim2.new(1,-20,1,-220)
ResultFrame.Position = UDim2.new(0,10,0,220)
ResultFrame.CanvasSize = UDim2.new(0,0,0,0)
ResultFrame.ScrollBarImageTransparency = 0
ResultFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
ResultFrame.Parent = MainFrame

local UIList = Instance.new("UIListLayout", ResultFrame)
UIList.Padding = UDim.new(0,3)

-- Close/Minimize Logic
local minimized = false
MinBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	SearchBox.Visible = not minimized
	AutoFrame.Visible = false
	ResultFrame.Visible = not minimized
	ClearBtn.Visible = not minimized
	MainFrame.Size = minimized and UDim2.new(0,320,0,30) or UDim2.new(0,320,0,340)
end)

CloseBtn.MouseButton1Click:Connect(function()
	clearResults()
	clearESPs()
	ScreenGui:Destroy()
end)

-- Functions
local function clearResults()
	for _,v in pairs(ResultFrame:GetChildren()) do
		if v:IsA("TextLabel") then v:Destroy() end
	end
	ResultFrame.CanvasSize = UDim2.new(0,0,0,0)
end

local function addResult(text)
	local Label = Instance.new("TextLabel")
	Label.Size = UDim2.new(1,-10,0,25)
	Label.BackgroundColor3 = Color3.fromRGB(50,50,50)
	Label.TextWrapped = true
	Label.TextXAlignment = Enum.TextXAlignment.Left
	Label.Text = text
	Label.TextColor3 = Color3.new(1,1,1)
	Label.Parent = ResultFrame
	ResultFrame.CanvasSize = UDim2.new(0,0,0,UIList.AbsoluteContentSize.Y + 5)
end

-- Build pet list
local allPetsFront = {} -- front name (without [..])
local allPetsFull = {} -- front name -> list full names

local function buildPetList()
	allPetsFront = {}
	allPetsFull = {}
	for _,player in pairs(Players:GetPlayers()) do
		local backpack = player:FindFirstChild("Backpack")
		if backpack then
			for _,item in pairs(backpack:GetChildren()) do
				local fullName = item.Name
				local nameFront = fullName:match("^[^%[]+"):gsub("%s+$","")
				if not allPetsFront[nameFront] then
					allPetsFront[nameFront] = true
					allPetsFull[nameFront] = {}
				end
				table.insert(allPetsFull[nameFront], fullName)
			end
		end
	end
end

-- ESP Logic: Highlight + Beam
local ESPs = {} -- Player -> {highlight, beam, attachments}

local function createESP(targetPlayer)
	if not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
	if ESPs[targetPlayer] then return end
	local hrp = targetPlayer.Character.HumanoidRootPart

	-- Highlight
	local highlight = Instance.new("Highlight")
	highlight.Adornee = targetPlayer.Character
	highlight.FillColor = Color3.fromRGB(0,255,0)
	highlight.FillTransparency = 0.5
	highlight.OutlineColor = Color3.fromRGB(0,255,0)
	highlight.OutlineTransparency = 0
	highlight.Parent = targetPlayer.Character

	-- Beam
	local att0 = Instance.new("Attachment")
	att0.Position = Vector3.new(0,0,0)
	att0.Parent = workspace.CurrentCamera

	local att1 = Instance.new("Attachment")
	att1.Position = Vector3.new(0,3,0)
	att1.Parent = hrp

	local beam = Instance.new("Beam")
	beam.Attachment0 = att0
	beam.Attachment1 = att1
	beam.Color = ColorSequence.new(Color3.fromRGB(0,255,0))
	beam.Width0 = 0.1
	beam.Width1 = 0.1
	beam.FaceCamera = true
	beam.Parent = hrp

	ESPs[targetPlayer] = {highlight=highlight, beam=beam, att0=att0, att1=att1}
end

local function clearESPs()
	for player,data in pairs(ESPs) do
		if data.highlight then data.highlight:Destroy() end
		if data.beam then
			data.beam:Destroy()
			data.att0:Destroy()
			data.att1:Destroy()
		end
	end
	ESPs = {}
end

-- Autocomplete logic
local function showAutocomplete(keyword)
	for _,v in pairs(AutoFrame:GetChildren()) do
		if v:IsA("TextButton") then v:Destroy() end
	end
	if keyword == "" then
		AutoFrame.Visible = false
		return
	end
	local count = 0
	for nameFront,_ in pairs(allPetsFront) do
		if string.find(string.lower(nameFront), string.lower(keyword)) then
			local btn = Instance.new("TextButton")
			btn.Size = UDim2.new(1,-4,0,25)
			btn.Text = nameFront
			btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
			btn.TextColor3 = Color3.new(1,1,1)
			btn.TextXAlignment = Enum.TextXAlignment.Left
			btn.Parent = AutoFrame
			btn.MouseButton1Click:Connect(function()
				SearchBox.Text = nameFront
				AutoFrame.Visible = false
				performSearch()
			end)
			count = count + 1
			if count >= 5 then break end
		end
	end
	AutoFrame.Visible = count>0
end

-- Search function
function performSearch()
	clearResults()
	clearESPs()
	local keyword = string.lower(SearchBox.Text)
	if keyword == "" then return end
	for frontName, fullNames in pairs(allPetsFull) do
		if string.find(string.lower(frontName), keyword) then
			for _,fullName in pairs(fullNames) do
				for _,player in pairs(Players:GetPlayers()) do
					local backpack = player:FindFirstChild("Backpack")
					if backpack then
						for _,item in pairs(backpack:GetChildren()) do
							if item.Name == fullName then
								addResult("Player: "..player.Name.." | Pet: "..fullName)
								createESP(player)
							end
						end
					end
				end
			end
		end
	end
end

-- TextBox events
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
	showAutocomplete(SearchBox.Text)
end)

SearchBox.FocusLost:Connect(function(enterPressed)
	if enterPressed then
		AutoFrame.Visible = false
		performSearch()
	end
end)

-- Clear Button
ClearBtn.MouseButton1Click:Connect(function()
	clearResults()
	clearESPs()
	SearchBox.Text = ""
	AutoFrame.Visible = false
end)

-- Init
buildPetList()
