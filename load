-- PET FINDER + ESP | FINAL STABLE VERSION (Delta Safe)

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Hapus GUI lama
local old = player.PlayerGui:FindFirstChild("PetFinderGUI")
if old then old:Destroy() end

-- GUI
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.Name = "PetFinderGUI"
gui.ResetOnSpawn = false

-- MAIN FRAME
local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0,360,0,300)
main.Position = UDim2.new(0.35,0,0.25,0)
main.BackgroundColor3 = Color3.fromRGB(25,25,25)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true

-- HEADER
local header = Instance.new("Frame", main)
header.Size = UDim2.new(1,0,0,30)
header.BackgroundColor3 = Color3.fromRGB(40,40,40)

local title = Instance.new("TextLabel", header)
title.Size = UDim2.new(1,-70,1,0)
title.Position = UDim2.new(0,8,0,0)
title.Text = "Pet Finder + ESP"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextSize = 13
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left

-- HEADER BUTTON MAKER (PENTING)
local function headBtn(txt,x,col)
	local b = Instance.new("TextButton", header)
	b.Size = UDim2.new(0,30,1,0)
	b.Position = UDim2.new(1,x,0,0)
	b.Text = txt
	b.Font = Enum.Font.GothamBold
	b.TextSize = 14
	b.TextColor3 = Color3.new(1,1,1)
	b.BackgroundColor3 = col
	b.BorderSizePixel = 0
	return b
end

local minBtn   = headBtn("-", -60, Color3.fromRGB(90,90,90))
local closeBtn = headBtn("X", -30, Color3.fromRGB(170,70,70))

-- ICON (MINIMIZE MODE)
local icon = Instance.new("TextButton", gui)
icon.Size = UDim2.new(0,45,0,45)
icon.Position = UDim2.new(0,10,0.45,0)
icon.Text = "PET"
icon.Visible = false
icon.BackgroundColor3 = Color3.fromRGB(45,45,45)
icon.TextColor3 = Color3.new(1,1,1)
icon.Active = true
icon.Draggable = true

-- MIN / RESTORE
minBtn.MouseButton1Click:Connect(function()
	main.Visible = false
	icon.Visible = true
end)

icon.MouseButton1Click:Connect(function()
	main.Visible = true
	icon.Visible = false
end)

-- CLOSE (100% WORK)
closeBtn.MouseButton1Click:Connect(function()
	gui:Destroy()
end)

-- SEARCH BOX
local searchBox = Instance.new("TextBox", main)
searchBox.Position = UDim2.new(0,10,0,45)
searchBox.Size = UDim2.new(1,-20,0,28)
searchBox.PlaceholderText = "Nama pet (contoh: Rainbow Frost)"
searchBox.Text = ""
searchBox.Font = Enum.Font.Gotham
searchBox.TextSize = 13
searchBox.TextColor3 = Color3.new(1,1,1)
searchBox.BackgroundColor3 = Color3.fromRGB(35,35,35)
searchBox.BorderColor3 = Color3.fromRGB(80,80,80)

-- BUTTONS
local searchBtn = Instance.new("TextButton", main)
searchBtn.Size = UDim2.new(0,160,0,26)
searchBtn.Position = UDim2.new(0,10,0,80)
searchBtn.Text = "SEARCH"
searchBtn.Font = Enum.Font.GothamBold
searchBtn.TextSize = 12
searchBtn.TextColor3 = Color3.new(1,1,1)
searchBtn.BackgroundColor3 = Color3.fromRGB(60,120,200)

local clearBtn = Instance.new("TextButton", main)
clearBtn.Size = UDim2.new(0,160,0,26)
clearBtn.Position = UDim2.new(0,190,0,80)
clearBtn.Text = "CLEAR"
clearBtn.Font = Enum.Font.GothamBold
clearBtn.TextSize = 12
clearBtn.TextColor3 = Color3.new(1,1,1)
clearBtn.BackgroundColor3 = Color3.fromRGB(150,50,50)

-- RESULT LIST
local result = Instance.new("ScrollingFrame", main)
result.Position = UDim2.new(0,10,0,115)
result.Size = UDim2.new(1,-20,1,-125)
result.CanvasSize = UDim2.new(0,0,0,0)
result.ScrollBarImageTransparency = 0
result.BackgroundColor3 = Color3.fromRGB(30,30,30)
result.BorderColor3 = Color3.fromRGB(80,80,80)

local layout = Instance.new("UIListLayout", result)
layout.Padding = UDim.new(0,4)

-- ESP STORAGE
local ESPs = {}

local function clearESP()
	for _,h in pairs(ESPs) do
		if h then h:Destroy() end
	end
	ESPs = {}
end

local function clearResults()
	for _,v in pairs(result:GetChildren()) do
		if v:IsA("TextLabel") then v:Destroy() end
	end
	result.CanvasSize = UDim2.new(0,0,0,0)
	clearESP()
end

-- ADD RESULT
local function add(text)
	local l = Instance.new("TextLabel", result)
	l.Size = UDim2.new(1,-10,0,24)
	l.BackgroundColor3 = Color3.fromRGB(45,45,45)
	l.TextXAlignment = Left
	l.TextWrapped = true
	l.Font = Enum.Font.Gotham
	l.TextSize = 12
	l.TextColor3 = Color3.new(1,1,1)
	l.Text = text
	result.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 6)
end

-- CREATE HIGHLIGHT
local function mark(plr)
	if ESPs[plr] then return end
	if not plr.Character then return end

	local h = Instance.new("Highlight")
	h.Adornee = plr.Character
	h.FillColor = Color3.fromRGB(0,255,0)
	h.FillTransparency = 0.5
	h.OutlineColor = Color3.fromRGB(0,255,0)
	h.Parent = plr.Character

	ESPs[plr] = h
end

-- SEARCH LOGIC
local function search()
	clearResults()
	local key = searchBox.Text:lower()
	if key == "" then return end

	for _,plr in pairs(Players:GetPlayers()) do
		local bp = plr:FindFirstChild("Backpack")
		if bp then
			for _,it in pairs(bp:GetChildren()) do
				if it.Name:lower():find(key) then
					add("Player: "..plr.Name.." | Pet: "..it.Name)
					mark(plr)
				end
			end
		end
	end
end

searchBtn.MouseButton1Click:Connect(search)
clearBtn.MouseButton1Click:Connect(function()
	searchBox.Text = ""
	clearResults()
end)
